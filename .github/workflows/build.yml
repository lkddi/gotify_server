# 构建 Gotify 服务器 仓库为自建 Gitea
name: build
on: [push, pull_request]

jobs:
  gotify:
    runs-on: ubuntu-latest
    env:
      GOPROXY: https://goproxy.cn,direct
    steps:
      - uses: actions/setup-go@v6
        with:
          go-version: 1.25.x
      - uses: actions/setup-node@v6
        with:
          node-version: '24'
      - uses: actions/checkout@v6
      - name: 设置 npm 镜像源
        run: |
          npm config set registry https://registry.npmmirror.com/
          yarn config set registry https://registry.npmmirror.com/
      - run: npm install -g yarn
      - run: yarn --version
      - name: 设置 Go 代理
        run: go env -w GOPROXY=$GOPROXY
      - run: (cd ui && yarn config set registry https://registry.npmmirror.com/ && yarn)
      - run: make build-js
      - run: go mod download
      - name: 生成 vendor 依赖以避免容器内联网下载
        run: go mod vendor
      - name: 安装 golangci-lint（优先 go install，失败则使用 Docker 镜像）
        run: |
          set -e
          if ! command -v golangci-lint >/dev/null 2>&1; then
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.60.3 || true
          fi
          if command -v golangci-lint >/dev/null 2>&1; then
            golangci-lint version
          else
            echo "golangci-lint 不在本地，后续使用 Docker 镜像运行"
          fi
      - name: 运行 golangci-lint
        run: |
          if command -v golangci-lint >/dev/null 2>&1; then
            golangci-lint run --timeout=5m
          else
            # Run golangci-lint in Docker with proper working directory and module setup
            # Use official golangci/golangci-lint image which supports newer Go versions
            # Explicitly specify the module name instead of using ./...
            docker run --rm \
              -e GOPROXY=$GOPROXY \
              -e GO111MODULE=on \
              -v "$PWD:/work" -w /work \
              -v $HOME/go/pkg/mod:/go/pkg/mod:ro \
              golangci/golangci-lint:v1.61.0 golangci-lint run --timeout=5m github.com/gotify/server/v2/...
          fi
      - run: make download-tools
      - run: make test
      - name: 设置前端依赖镜像源并检查
        run: |
          cd ui
          yarn config set registry https://registry.npmmirror.com/
          cd ..
          make check-ci
      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - if: startsWith(github.ref, 'refs/tags/v')
        run: echo "VERSION=${GITHUB_REF/refs\/tags\/v/}" >> $GITHUB_ENV
      - if: startsWith(github.ref, 'refs/tags/v')
        run: |
          export LD_FLAGS="-w -s -X main.Version=$VERSION -X main.BuildDate=$(date "+%F-%T") -X main.Commit=$(git rev-parse --verify HEAD) -X main.Mode=prod"
          echo "LD_FLAGS=$LD_FLAGS" >> $GITHUB_ENV

          # 确保 UI 构建使用国内源
          cd ui && yarn config set registry https://registry.npmmirror.com/ && cd ..
          make build
          sudo chown -R $UID build
          make package-zip
          ls -lath build
      - if: startsWith(github.ref, 'refs/tags/v')
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - if: startsWith(github.ref, 'refs/tags/v')
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      - if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.DOCKER_GHCR_USER }}
          password: ${{ secrets.DOCKER_GHCR_PASS }}
      - if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: harbor.ay.lc
          username: ${{ secrets.HARBOR_USER }}
          password: ${{ secrets.HARBOR_PASS }}
      - if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # 设置 Yarn registry 为国内源
          cd ui && yarn config set registry https://registry.npmmirror.com/ && cd ..
          make DOCKER_BUILD_PUSH=true HARBOR_REGISTRY=harbor.ay.lc HARBOR_PROJECT=gotify build-docker
      - if: startsWith(github.ref, 'refs/tags/v')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/*.zip
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true